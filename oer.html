<!DOCTYPE html> 
<html> 
<head> 
  <title>PROPER&trade; - Semantic Rich Text Editor</title>  
  
  <!-- Styles -->
  <link href="stylesheets/page.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="stylesheets/proper.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="stylesheets/oer.css" media="screen" rel="stylesheet" type="text/css" />
  
  <!-- Libraries -->
  <script src="lib/jquery-min.js"></script>
  <script src="lib/jquery.hotkeys.js"></script>
  <script src="lib/underscore.js"></script>
    
  <!-- Source -->
  <script src="proper.js"></script>

  <script>
    // Proper Init
    $(function() {


    // DOM Selection
    // -------------
    
    // Returns the current selection as a dom range.
    function saveSelection() {
      if (window.getSelection) {
        var sel = window.getSelection();
        if (sel.rangeCount > 0) {
          return sel.getRangeAt(0);
        }
      } else if (document.selection && document.selection.createRange) { // IE
        return document.selection.createRange();
      }
      return null;
    }
    
    // Selects the given dom range.
    function restoreSelection(range) {
      if (range) {
        if (window.getSelection) {
          var sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } else if (document.selection && range.select) { // IE
          range.select();
        }
      }
    }
    
    // Selects the whole editing area.
    function selectAll() {
      var el = $(activeElement)[0],
        range;
      
      if (document.body.createTextRange) { // IE < 9
        range = document.body.createTextRange();
        range.moveToElementText(el);
        range.select();
      } else {
        range = document.createRange();
        range.selectNodeContents(el);
      }

      restoreSelection(range);
    }
    
    // Applies fn and tries to preserve the user's selection and cursor
    // position.
    function doWithSelection (fn) {
      // Before
      var sel = saveSelection()
      if (sel) {
        var startContainer = sel.startContainer
        ,   startOffset    = sel.startOffset
        ,   endContainer   = sel.endContainer
        ,   endOffset      = sel.endOffset;
      }
      
      fn();
      
      if (sel) {
        // After
        function isInDom(node) {
          if (node) {
            if (node === document.body) return true;
            if (node.parentNode) return isInDom(node.parentNode);
          }
          return false;
        }
        if (isInDom(startContainer)) {
          sel.setStart(startContainer, startOffset);
        }
        if (isInDom(endContainer)) {
          sel.setEnd(endContainer, endOffset);
        }
        restoreSelection(sel);
      }
    }


      var options = {
          allowedTags: { span: ['class'] },
          commands: {

subscript: {
  isActive: function() {
    return document.queryCommandState('subscript', false, true);
  },
  exec: function() {
    document.execCommand('subscript', false, true);
  }
},

term: {
  isActive: function() {
    var sel = saveSelection();
    var start = sel.startContainer;
    var end = sel.endContainer;
    
    return $(start).parents('span.term').length + $(end).parents('span.term').length > 0;
  },
  toggleOff: function() {
    var sel = saveSelection();
    $(sel.startContainer).parents('span.term').contents().first().unwrap();
    $(sel.endContainer).parents('span.term').contents().first().unwrap();
  
  },
  toggleOn: function() {
    var id = 'unique-id';
    // Get all of the text and elements that are hilighted
    // So we can re-insert them later
    var sel = saveSelection();
        
    // There are several cases to consider:
    // - Start and End elements are the same
    // - Start and End Elements are different
    var text = "WHOOPS!";
    if (sel.startContainer == sel.endContainer) {
      text = sel.startContainer.data.substring(sel.startOffset, sel.endOffset);
    }
    
    document.execCommand('inserthorizontalrule', false, id);
    var hr = $('.content').find('#' + id);
    
    var term = $('<span class="term"/>').text(text);
    hr.replaceWith(term);
    
  }
},
      
      }
      };

      window.editor = new Proper(options);
      
      $('.content').click(function() {
        editor.activate($(this), {
          placeholder: 'Enter Text',
          controlsTarget: $('#tools'),
          codeFontFamily: 'Monaco, Consolas, "Lucida Console", monospace',

          controls: _.flatten([ editor.defaultControls,
{ title: 'Subscript', command: 'subscript', shortcut: 'shift+down' },
{ title: 'Term',      command: 'term',      shortcut: 'ctrl+shift+t' },
          
          ]),

        });
        
        // Update node when editor commands are applied
        editor.bind('changed', function() {
          $('#source').text(editor.content());
        });
      });
      
      $('h2.no-markup').click(function() {
        editor.activate($(this), { markup: false, multiline: false });
        
        // Update node when editor commands are applied
        editor.bind('changed', function() {
          $('#source').text(editor.content());
        });
      });
    });
  </script>
  
</head>
<body>
  <h1>PROPER&trade; - Semantic Rich Text Editor (Version 0.3.1)</h1>
  
  <div id="main">
    <div id="tools"></div>
    <div class="content">
      <p>Text wants to be <strong>editable</strong>.<br/>But text also wants to be <strong>meaningful</strong>.
      </p>
    </div>
  
    <div class="content">
      <p>
        On the right, you see the <em>sanitized</em> (and hopefully correct) HTML output.
      </p>
      <p>
        Known issues:
        <ul>
          <li>Does not yet consider <code>markup</code> for pasted content</li>
        </ul>
      </p>
    </div>
    
    <h2 class="no-markup">
      Here we prevent from using markup and newlines
    </h2>
  </div>
  
  <div id="source">

  </div>
  <br class="clear"/>
  <div class="credits">
    Straight from the labs of <a href="http://quasipartikel.at">Quaspartikel</a> 
    and <a href="http://froodee.at/">froodee</a>. 
  </div>
  
  <a href="http://github.com/michael/proper"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://assets2.github.com/img/71eeaab9d563c2b3c590319b398dd35683265e85?repo=&url=http%3A%2F%2Fs3.amazonaws.com%2Fgithub%2Fribbons%2Fforkme_right_gray_6d6d6d.png&path=" alt="Fork me on GitHub"></a>
</body> 
</html>
